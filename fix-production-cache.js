#!/usr/bin/env node

/**
 * üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö–°: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω–µ
 * 
 * –ü—Ä–æ–±–ª–µ–º–∞: –ù–∞ –ø—Ä–æ–¥–∞–∫—à–Ω–µ –µ—Å—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—Ö–æ–¥—è—Ç –∞–¥–º–∏–Ω–∫—É
 * –†–µ—à–µ–Ω–∏–µ: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ë–î
 */

import { drizzle } from 'drizzle-orm/postgres-js';
import postgres from 'postgres';

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å–±—Ä–æ—Å–æ–º —Ñ–æ—Ä–º
const FIX_SETTINGS = {
  // –û–¢–ö–õ–Æ–ß–ê–ï–ú –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü - –≥–ª–∞–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞ —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º
  pagesEnabled: 'false',
  pagesPreload: 'false',
  
  // Network First —Å—Ç—Ä–∞—Ç–µ–≥–∏—è - –≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  cacheStrategy: 'networkFirst',
  
  // –í–∫–ª—é—á–∞–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏ –∏ API (—ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ)
  cacheEnabled: 'true',
  staticAssetsEnabled: 'true',
  apiDataEnabled: 'true',
  
  // –†–∞–∑—É–º–Ω—ã–µ —Å—Ä–æ–∫–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
  staticAssetsDuration: '30', // 30 –¥–Ω–µ–π –¥–ª—è —Å—Ç–∞—Ç–∏–∫–∏
  apiDataDuration: '15', // 15 –º–∏–Ω—É—Ç –¥–ª—è API
  staticAssetsMaxSize: '100', // 100 MB
  apiEndpoints: 'clinics,cities,districts,services'
};

async function fixProductionCache() {
  console.log('üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö–°: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω–µ');
  console.log('üìã –¶–µ–ª—å: –£—Å—Ç—Ä–∞–Ω–∏—Ç—å —Å–±—Ä–æ—Å —Ñ–æ—Ä–º –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö');
  
  const { DATABASE_URL } = process.env;
  
  if (!DATABASE_URL) {
    console.error('‚ùå DATABASE_URL –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è');
    console.log('üí° –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è DATABASE_URL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
    process.exit(1);
  }

  try {
    const sql = postgres(DATABASE_URL);
    const db = drizzle(sql);
    
    console.log('üîß –ü—Ä–∏–º–µ–Ω—è–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è...');
    
    for (const [key, value] of Object.entries(FIX_SETTINGS)) {
      try {
        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É
        await sql`
          INSERT INTO site_settings (key, value, created_at, updated_at)
          VALUES (${key}, ${value}, NOW(), NOW())
          ON CONFLICT (key) 
          DO UPDATE SET 
            value = EXCLUDED.value,
            updated_at = NOW()
        `;
        
        console.log(`‚úÖ ${key} = ${value}`);
      } catch (error) {
        console.error(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ${key}:`, error.message);
      }
    }
    
    console.log('üéâ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ò–ú–ï–ù–ï–ù–´!');
    console.log('');
    console.log('üì± –†–µ–∑—É–ª—å—Ç–∞—Ç:');
    console.log('  ‚úÖ –§–æ—Ä–º—ã –ù–ï –±—É–¥—É—Ç —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å—Å—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö');
    console.log('  ‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Å–µ–≥–¥–∞ —Å–≤–µ–∂–∏–µ (Network First)');
    console.log('  ‚úÖ –°—Ç–∞—Ç–∏–∫–∞ –∏ API –∫–µ—à–∏—Ä—É—é—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ');
    console.log('  ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∫–∏ —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞—é—Ç');
    console.log('');
    console.log('üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:');
    console.log('  1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä');
    console.log('  2. –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º');
    console.log('  3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ —Ñ–æ—Ä–º—ã –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è');
    
  } catch (error) {
    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
    process.exit(1);
  }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
fixProductionCache().then(() => {
  console.log('‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ');
  process.exit(0);
}).catch((error) => {
  console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:', error);
  process.exit(1);
});
