# Исправление стабильности на продакшене

## Проблема
502 Bad Gateway спустя несколько часов работы - приложение падает или зависает.

## Решение
Исправлены настройки PM2, пула БД и обработка ошибок.

## Команды для перезапуска на сервере

```bash
cd /var/www/clinici.md

# 1. Остановить все процессы PM2
pm2 stop all
pm2 delete all

# 2. Убить все процессы на порту 5000
lsof -ti:5000 | xargs kill -9 2>/dev/null || fuser -k 5000/tcp 2>/dev/null || true

# 3. Проверить что порт свободен
netstat -tlnp | grep :5000 || echo "Порт свободен"

# 4. Забрать последние изменения из Git
git pull origin main

# 5. Пересобрать проект (если были изменения в коде)
npm run build

# 6. Создать директорию для логов если её нет
mkdir -p logs

# 7. Запустить через PM2 с новой конфигурацией
pm2 start ecosystem.config.cjs

# 8. Проверить статус
pm2 status

# 9. Посмотреть логи
pm2 logs clinici-md --lines 50

# 10. Проверить health endpoint
curl http://localhost:5000/health

# 11. Сохранить конфигурацию PM2 для автозапуска
pm2 save

# 12. Настроить автозапуск PM2 при перезагрузке системы
pm2 startup
# Выполнить команду которую выдаст PM2 (обычно sudo env PATH=... pm2 startup systemd -u root --hp /root)
```

## Что исправлено

1. **PM2 конфигурация**:
   - Используется `npm start` вместо `tsx` (собранный код)
   - Уменьшен лимит памяти до 512MB
   - Увеличен `max_restarts` до 50
   - Добавлен `wait_ready` для ожидания готовности сервера
   - Улучшена обработка ошибок

2. **Пул БД**:
   - Уменьшено максимальное количество соединений до 10
   - Увеличен `idleTimeoutMillis` до 60 секунд
   - Добавлены таймауты на запросы (30 секунд)
   - Добавлена обработка ошибок пула

3. **Обработка ошибок**:
   - Улучшена обработка необработанных исключений
   - Добавлен graceful shutdown
   - Health check теперь проверяет подключение к БД

## Мониторинг

После запуска проверяй логи каждые несколько часов:

```bash
# Логи ошибок
pm2 logs clinici-md --err --lines 100

# Статус и использование ресурсов
pm2 monit

# Health check
curl http://localhost:5000/health | jq
```

## Автоматический мониторинг (опционально)

Можно настроить cron для проверки health endpoint каждые 5 минут:

```bash
# Добавить в crontab
crontab -e

# Добавить строку:
*/5 * * * * curl -f http://localhost:5000/health > /dev/null 2>&1 || pm2 restart clinici-md
```

