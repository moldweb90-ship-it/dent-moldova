<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–µ—à–∞</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; color: #2563eb; }
        .stat-label { font-size: 14px; color: #666; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–µ—à–∞</h1>
    
    <div class="test-section info">
        <h3>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h3>
        <button onclick="loadCacheStats()">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        <button onclick="startAutoRefresh()">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–∫–∞–∂–¥—ã–µ 3 —Å–µ–∫)</button>
        <button onclick="stopAutoRefresh()">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</button>
        
        <div id="cache-stats" class="stats"></div>
    </div>

    <div class="test-section info">
        <h3>üß™ –¢–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <button onclick="testCaching()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è</button>
        <div id="test-results" class="log"></div>
    </div>

    <div class="test-section info">
        <h3>üì± –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º</h3>
        <div class="log">
1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
2. –ü—Ä–æ–π–¥–∏—Ç–µ—Å—å –ø–æ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
3. –ó–∞–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä
4. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 2-3 –º–∏–Ω—É—Ç—ã
5. –û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä —Å–Ω–æ–≤–∞
6. –°–∞–π—Ç –ù–ï –¥–æ–ª–∂–µ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è!

–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
- –§–∞–π–ª–æ–≤ –≤ –∫–µ—à–µ: > 0
- –†–∞–∑–º–µ—Ä –∫–µ—à–∞: > 0 MB
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: > 0%
        </div>
    </div>

    <script>
        let autoRefreshInterval;

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–µ—à–∞
        async function loadCacheStats() {
            const statsDiv = document.getElementById('cache-stats');
            statsDiv.innerHTML = '<div>–ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...</div>';

            try {
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É Service Worker
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    const messageChannel = new MessageChannel();
                    
                    messageChannel.port1.onmessage = (event) => {
                        const swStats = event.data;
                        if (swStats) {
                            displayStats(swStats);
                        }
                    };
                    
                    navigator.serviceWorker.controller.postMessage(
                        { type: 'GET_CACHE_STATS' },
                        [messageChannel.port2]
                    );
                } else {
                    statsDiv.innerHTML = '<div class="error">Service Worker –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω</div>';
                }
            } catch (error) {
                statsDiv.innerHTML = `<div class="error">–û—à–∏–±–∫–∞: ${error.message}</div>`;
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function displayStats(stats) {
            const statsDiv = document.getElementById('cache-stats');
            
            const hitRate = stats.hitCount + stats.missCount > 0 
                ? Math.round((stats.hitCount / (stats.hitCount + stats.missCount)) * 100) 
                : 0;
            
            const totalSize = stats.totalSize ? Math.round(stats.totalSize / 1024 / 1024 * 100) / 100 : 0;
            
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalFiles || 0}</div>
                    <div class="stat-label">–§–∞–π–ª–æ–≤ –≤ –∫–µ—à–µ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalSize} MB</div>
                    <div class="stat-label">–†–∞–∑–º–µ—Ä –∫–µ—à–∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${hitRate}%</div>
                    <div class="stat-label">–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.hitCount || 0}</div>
                    <div class="stat-label">–ü–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫–µ—à</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.missCount || 0}</div>
                    <div class="stat-label">–ü—Ä–æ–º–∞—Ö–æ–≤ –∫–µ—à–∞</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${new Date(stats.lastUpdated || Date.now()).toLocaleTimeString()}</div>
                    <div class="stat-label">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div>
                </div>
            `;
        }

        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        function startAutoRefresh() {
            stopAutoRefresh();
            autoRefreshInterval = setInterval(loadCacheStats, 3000);
            loadCacheStats();
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        // –¢–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
        async function testCaching() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.textContent = '–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è...';

            try {
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
                const tests = [
                    { name: 'API –≥–æ—Ä–æ–¥–æ–≤', url: '/api/cities' },
                    { name: 'API –∫–ª–∏–Ω–∏–∫', url: '/api/clinics' },
                    { name: 'CSS —Ñ–∞–π–ª', url: '/assets/index.css' },
                    { name: '–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞', url: '/' }
                ];

                let results = 'üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:\n\n';
                
                for (const test of tests) {
                    try {
                        const response = await fetch(test.url);
                        results += `‚úÖ ${test.name}: ${response.status}\n`;
                    } catch (error) {
                        results += `‚ùå ${test.name}: ${error.message}\n`;
                    }
                }
                
                results += '\nüí° –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤—ã—à–µ - –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –¥–∞–Ω–Ω—ã–µ!';
                
                resultsDiv.textContent = results;
                resultsDiv.parentElement.className = 'test-section success';
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞
                setTimeout(loadCacheStats, 1000);
                
            } catch (error) {
                resultsDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`;
                resultsDiv.parentElement.className = 'test-section error';
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.addEventListener('load', () => {
            loadCacheStats();
        });

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏
        window.addEventListener('beforeunload', () => {
            stopAutoRefresh();
        });
    </script>
</body>
</html>
