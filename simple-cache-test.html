<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –∫–µ—à–∞</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üß™ –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –∫–µ—à–∞</h1>
    
    <div class="test">
        <h3>1. –ü—Ä–æ–≤–µ—Ä–∫–∞ Service Worker</h3>
        <button onclick="checkServiceWorker()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å SW</button>
        <div id="sw-status" class="log"></div>
    </div>

    <div class="test">
        <h3>2. –¢–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <button onclick="testCache()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
        <div id="cache-results" class="log"></div>
    </div>

    <div class="test">
        <h3>3. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∞</h3>
        <button onclick="getCacheStats()">–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
        <div id="stats-results" class="log"></div>
    </div>

    <script>
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ Service Worker
        async function checkServiceWorker() {
            const statusDiv = document.getElementById('sw-status');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        statusDiv.textContent = `‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω\nScope: ${registration.scope}\nState: ${registration.active?.state || '–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω'}`;
                        statusDiv.parentElement.className = 'test success';
                    } else {
                        statusDiv.textContent = '‚ùå Service Worker –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
                        statusDiv.parentElement.className = 'test error';
                    }
                } catch (error) {
                    statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                    statusDiv.parentElement.className = 'test error';
                }
            } else {
                statusDiv.textContent = '‚ùå Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                statusDiv.parentElement.className = 'test error';
            }
        }

        // –¢–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
        async function testCache() {
            const resultsDiv = document.getElementById('cache-results');
            resultsDiv.textContent = '–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è...';

            try {
                // –¢–µ—Å—Ç–∏—Ä—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤
                const tests = [
                    { name: 'API –≥–æ—Ä–æ–¥–æ–≤', url: '/api/cities' },
                    { name: 'API –∫–ª–∏–Ω–∏–∫', url: '/api/clinics' },
                    { name: 'CSS —Ñ–∞–π–ª', url: '/assets/index.css' }
                ];

                let results = 'üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞:\n\n';
                
                for (const test of tests) {
                    try {
                        const startTime = performance.now();
                        const response = await fetch(test.url);
                        const endTime = performance.now();
                        const duration = Math.round(endTime - startTime);
                        
                        results += `‚úÖ ${test.name}: ${response.status} (${duration}ms)\n`;
                    } catch (error) {
                        results += `‚ùå ${test.name}: ${error.message}\n`;
                    }
                }
                
                results += '\nüí° –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ç–µ—Å—Ç - –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±—ã—Å—Ç—Ä–µ–µ!';
                
                resultsDiv.textContent = results;
                resultsDiv.parentElement.className = 'test success';
                
            } catch (error) {
                resultsDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`;
                resultsDiv.parentElement.className = 'test error';
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–µ—à–∞
        async function getCacheStats() {
            const statsDiv = document.getElementById('stats-results');
            statsDiv.textContent = '–ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É...';

            try {
                if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
                    const messageChannel = new MessageChannel();
                    
                    messageChannel.port1.onmessage = (event) => {
                        const stats = event.data;
                        if (stats) {
                            const hitRate = stats.hitCount + stats.missCount > 0 
                                ? Math.round((stats.hitCount / (stats.hitCount + stats.missCount)) * 100) 
                                : 0;
                            
                            const totalSize = stats.totalSize ? Math.round(stats.totalSize / 1024 / 1024 * 100) / 100 : 0;
                            
                            statsDiv.textContent = `üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–µ—à–∞:
–§–∞–π–ª–æ–≤ –≤ –∫–µ—à–µ: ${stats.totalFiles || 0}
–†–∞–∑–º–µ—Ä –∫–µ—à–∞: ${totalSize} MB
–ü–æ–ø–∞–¥–∞–Ω–∏–π: ${stats.hitCount || 0}
–ü—Ä–æ–º–∞—Ö–æ–≤: ${stats.missCount || 0}
–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${hitRate}%
–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date(stats.lastUpdated || Date.now()).toLocaleTimeString()}`;
                            
                            statsDiv.parentElement.className = 'test success';
                        } else {
                            statsDiv.textContent = '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç Service Worker';
                            statsDiv.parentElement.className = 'test error';
                        }
                    };
                    
                    navigator.serviceWorker.controller.postMessage(
                        { type: 'GET_CACHE_STATS' },
                        [messageChannel.port2]
                    );
                } else {
                    statsDiv.textContent = '‚ùå Service Worker –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω';
                    statsDiv.parentElement.className = 'test error';
                }
            } catch (error) {
                statsDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                statsDiv.parentElement.className = 'test error';
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            setTimeout(checkServiceWorker, 1000);
        });
    </script>
</body>
</html>
