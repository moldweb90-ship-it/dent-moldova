#!/bin/bash

# ะกะบัะธะฟั ะฑะตะทะพะฟะฐัะฝะพะณะพ ะดะตะฟะปะพั ะดะปั ะฟัะพะดะฐะบัะตะฝะฐ
echo "๐ ะะฐัะธะฝะฐะตะผ ะฑะตะทะพะฟะฐัะฝัะน ะดะตะฟะปะพะน Clinici.md..."

# ะกะพะทะดะฐะตะผ ะฟะฐะฟะบั ะดะปั ะปะพะณะพะฒ ะตัะปะธ ะตั ะฝะตั
mkdir -p logs

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ PM2 ะฟัะพัะตัั
echo "โน๏ธ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ PM2 ะฟัะพัะตัั..."
pm2 stop clinici-md || true

# ะกะพััะฐะฝัะตะผ ะฒะฐะถะฝัะต ัะฐะนะปั (ัะพัะพ ะบะปะธะฝะธะบ)
echo "๐พ ะกะพััะฐะฝัะตะผ ัะพัะพ ะบะปะธะฝะธะบ..."
if [ -d "img" ]; then
    cp -r img img_backup_$(date +%Y%m%d_%H%M%S) || true
    echo "โ ะคะพัะพ ัะพััะฐะฝะตะฝั ะฒ img_backup_$(date +%Y%m%d_%H%M%S)"
else
    echo "โ๏ธ ะะฐะฟะบะฐ img ะฝะต ะฝะฐะนะดะตะฝะฐ"
fi

# ะะฑะฝะพะฒะปัะตะผ ะบะพะด
echo "๐ฅ ะะฑะฝะพะฒะปัะตะผ ะบะพะด ะธะท Git..."
git pull origin main

# ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ
echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ..."
npm ci --only=production

# ะกะพะฑะธัะฐะตะผ ะฟัะพะตะบั
echo "๐จ ะกะพะฑะธัะฐะตะผ ะฟัะพะตะบั..."
npm run build

# ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะพัะพ ะตัะปะธ ะพะฝะธ ะฑัะปะธ
echo "๐ผ๏ธ ะัะพะฒะตััะตะผ ัะพัะพ ะบะปะธะฝะธะบ..."
if [ -d "img_backup_$(date +%Y%m%d_%H%M%S)" ]; then
    # ะะพัััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟะพัะปะตะดะฝะธะน backup
    latest_backup=$(ls -td img_backup_* | head -1)
    if [ -d "$latest_backup" ]; then
        cp -r "$latest_backup"/* img/ || true
        echo "โ ะคะพัะพ ะฒะพัััะฐะฝะพะฒะปะตะฝั ะธะท $latest_backup"
    fi
fi

# ะัะพะฒะตััะตะผ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั
echo "๐ ะัะพะฒะตััะตะผ ะฟะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั..."
if [ -z "$DATABASE_URL" ]; then
    echo "โ๏ธ DATABASE_URL ะฝะต ัััะฐะฝะพะฒะปะตะฝะฐ, ะทะฐะณััะถะฐะตะผ ะธะท .env"
    if [ -f ".env" ]; then
        export $(cat .env | grep -v '^#' | xargs)
    else
        echo "โ ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ!"
        exit 1
    fi
fi

# ะะฐะฟััะบะฐะตะผ ัะตัะตะท PM2
echo "๐ ะะฐะฟััะบะฐะตะผ ะฟัะธะปะพะถะตะฝะธะต ัะตัะตะท PM2..."
pm2 start ecosystem.config.cjs

# ะะดะตะผ ะทะฐะฟััะบะฐ
echo "โณ ะะดะตะผ ะทะฐะฟััะบะฐ ะฟัะธะปะพะถะตะฝะธั..."
sleep 10

# ะัะพะฒะตััะตะผ ััะฐััั
echo "๐ ะัะพะฒะตััะตะผ ััะฐััั..."
pm2 status

# ะัะพะฒะตััะตะผ health check
echo "๐ฅ ะัะพะฒะตััะตะผ health check..."
if curl -f http://localhost:5000/health > /dev/null 2>&1; then
    echo "โ Health check ะฟัะพัะตะป ััะฟะตัะฝะพ"
else
    echo "โ Health check ะฝะต ะฟัะพัะตะป, ะฟัะพะฒะตััะตะผ ะปะพะณะธ..."
    pm2 logs clinici-md --lines 20
    exit 1
fi

echo "๐ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ ััะฟะตัะฝะพ!"
echo "๐ ะกะฐะนั ะดะพัััะฟะตะฝ ะฝะฐ https://mdent.md/"
echo "๐ ะะพะณะธ: pm2 logs clinici-md"