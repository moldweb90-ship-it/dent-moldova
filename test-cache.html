<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç —Å–∏—Å—Ç–µ–º—ã –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è</h1>
    
    <div class="test-section info">
        <h3>üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é:</h3>
        <ol>
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ <a href="http://localhost:5000" target="_blank">http://localhost:5000</a></li>
            <li>–û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí –≤–∫–ª–∞–¥–∫–∞ Application ‚Üí Service Workers</li>
            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</li>
            <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω–∫—É: <a href="http://localhost:5000/admin" target="_blank">http://localhost:5000/admin</a></li>
            <li>–í–æ–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω–∫—É (admin/dancerboy)</li>
            <li>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí —Ç–∞–± "–ö–µ—à"</li>
            <li>–ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"</li>
            <li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å</li>
            <li>–ù–∞–∂–º–∏—Ç–µ "–û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à" –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∫–µ—à –æ—á–∏—Å—Ç–∏–ª—Å—è</li>
        </ol>
    </div>

    <div class="test-section">
        <h3>üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ Service Worker</h3>
        <button onclick="checkServiceWorker()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å Service Worker</button>
        <button onclick="checkCache()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–µ—à</button>
        <button onclick="clearCache()">–û—á–∏—Å—Ç–∏—Ç—å –∫–µ—à</button>
        <div id="sw-status" class="log"></div>
    </div>

    <div class="test-section">
        <h3>üìä –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</h3>
        <button onclick="testPerformance()">–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç</button>
        <div id="performance-results" class="log"></div>
    </div>

    <div class="test-section">
        <h3>üåê –¢–µ—Å—Ç API –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <button onclick="testApiCaching()">–¢–µ—Å—Ç API</button>
        <div id="api-results" class="log"></div>
    </div>

    <script>
        let swRegistration = null;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ Service Worker
        async function checkServiceWorker() {
            const statusDiv = document.getElementById('sw-status');
            statusDiv.innerHTML = '–ü—Ä–æ–≤–µ—Ä—è–µ–º Service Worker...';

            try {
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        swRegistration = registration;
                        statusDiv.innerHTML = `
                            ‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω<br>
                            –ê–∫—Ç–∏–≤–Ω—ã–π: ${registration.active ? '–î–∞' : '–ù–µ—Ç'}<br>
                            –û–∂–∏–¥–∞—é—â–∏–π: ${registration.waiting ? '–î–∞' : '–ù–µ—Ç'}<br>
                            –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–π: ${registration.installing ? '–î–∞' : '–ù–µ—Ç'}<br>
                            Scope: ${registration.scope}
                        `;
                        statusDiv.parentElement.className = 'test-section success';
                    } else {
                        statusDiv.innerHTML = '‚ùå Service Worker –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
                        statusDiv.parentElement.className = 'test-section error';
                    }
                } else {
                    statusDiv.innerHTML = '‚ùå Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                    statusDiv.parentElement.className = 'test-section error';
                }
            } catch (error) {
                statusDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                statusDiv.parentElement.className = 'test-section error';
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–µ—à–∞
        async function checkCache() {
            const statusDiv = document.getElementById('sw-status');
            statusDiv.innerHTML = '–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à...';

            try {
                const cacheNames = await caches.keys();
                let cacheInfo = `–ù–∞–π–¥–µ–Ω–æ –∫–µ—à–µ–π: ${cacheNames.length}<br>`;
                
                for (const cacheName of cacheNames) {
                    const cache = await caches.open(cacheName);
                    const keys = await cache.keys();
                    cacheInfo += `${cacheName}: ${keys.length} —Ñ–∞–π–ª–æ–≤<br>`;
                }
                
                statusDiv.innerHTML = cacheInfo;
                statusDiv.parentElement.className = 'test-section success';
            } catch (error) {
                statusDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–µ—à–∞: ${error.message}`;
                statusDiv.parentElement.className = 'test-section error';
            }
        }

        // –û—á–∏—Å—Ç–∫–∞ –∫–µ—à–∞
        async function clearCache() {
            const statusDiv = document.getElementById('sw-status');
            statusDiv.innerHTML = '–û—á–∏—â–∞–µ–º –∫–µ—à...';

            try {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                
                if (swRegistration && swRegistration.active) {
                    swRegistration.active.postMessage({ type: 'CLEAR_CACHE' });
                }
                
                statusDiv.innerHTML = '‚úÖ –ö–µ—à –æ—á–∏—â–µ–Ω';
                statusDiv.parentElement.className = 'test-section success';
            } catch (error) {
                statusDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∫–µ—à–∞: ${error.message}`;
                statusDiv.parentElement.className = 'test-section error';
            }
        }

        // –¢–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        async function testPerformance() {
            const resultsDiv = document.getElementById('performance-results');
            resultsDiv.innerHTML = '–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏...';

            const testUrl = 'http://localhost:5000';
            const iterations = 3;
            let totalTime = 0;

            for (let i = 0; i < iterations; i++) {
                const startTime = performance.now();
                try {
                    await fetch(testUrl);
                    const endTime = performance.now();
                    const loadTime = endTime - startTime;
                    totalTime += loadTime;
                    resultsDiv.innerHTML += `–ü–æ–ø—ã—Ç–∫–∞ ${i + 1}: ${loadTime.toFixed(2)}ms<br>`;
                } catch (error) {
                    resultsDiv.innerHTML += `–ü–æ–ø—ã—Ç–∫–∞ ${i + 1}: –û—à–∏–±–∫–∞ - ${error.message}<br>`;
                }
            }

            const avgTime = totalTime / iterations;
            resultsDiv.innerHTML += `<br>–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏: ${avgTime.toFixed(2)}ms`;
            
            if (avgTime < 100) {
                resultsDiv.parentElement.className = 'test-section success';
            } else {
                resultsDiv.parentElement.className = 'test-section error';
            }
        }

        // –¢–µ—Å—Ç API –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
        async function testApiCaching() {
            const resultsDiv = document.getElementById('api-results');
            resultsDiv.innerHTML = '–¢–µ—Å—Ç–∏—Ä—É–µ–º API –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ...';

            const apiUrl = 'http://localhost:5000/api/cities';
            
            try {
                // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å
                const start1 = performance.now();
                const response1 = await fetch(apiUrl);
                const end1 = performance.now();
                const time1 = end1 - start1;
                
                // –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑ –∫–µ—à–∞)
                const start2 = performance.now();
                const response2 = await fetch(apiUrl);
                const end2 = performance.now();
                const time2 = end2 - start2;
                
                resultsDiv.innerHTML = `
                    –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å: ${time1.toFixed(2)}ms<br>
                    –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å: ${time2.toFixed(2)}ms<br>
                    –£—Å–∫–æ—Ä–µ–Ω–∏–µ: ${(time1 / time2).toFixed(2)}x<br>
                    –°—Ç–∞—Ç—É—Å: ${response1.status} ‚Üí ${response2.status}
                `;
                
                if (time2 < time1 * 0.5) {
                    resultsDiv.parentElement.className = 'test-section success';
                } else {
                    resultsDiv.parentElement.className = 'test-section error';
                }
            } catch (error) {
                resultsDiv.innerHTML = `‚ùå –û—à–∏–±–∫–∞ API —Ç–µ—Å—Ç–∞: ${error.message}`;
                resultsDiv.parentElement.className = 'test-section error';
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            checkServiceWorker();
        });
    </script>
</body>
</html>
