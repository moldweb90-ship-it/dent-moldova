<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç Service Worker</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        .info { background-color: #d1ecf1; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .log { background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 3px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üîß –¢–µ—Å—Ç Service Worker</h1>
    
    <div class="test info">
        <h3>üìã –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:</h3>
        <div class="log">
1. –û—Ç–∫—Ä–æ–π—Ç–µ DevTools (F12) ‚Üí Console
2. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
3. –î–æ–ª–∂–Ω–æ –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ "Service Worker –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω"
4. –ï—Å–ª–∏ –Ω–µ—Ç - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∫–ª–∞–¥–∫—É Application ‚Üí Service Workers
5. –ï—Å–ª–∏ SW –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω - –ø—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ
        </div>
    </div>

    <div class="test">
        <h3>1. –†—É—á–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker</h3>
        <button onclick="registerSW()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å SW</button>
        <div id="sw-register" class="log"></div>
    </div>

    <div class="test">
        <h3>2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞</h3>
        <button onclick="checkStatus()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
        <div id="sw-status" class="log"></div>
    </div>

    <div class="test">
        <h3>3. –¢–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
        <button onclick="testCache()">–¢–µ—Å—Ç –∫–µ—à–∞</button>
        <div id="cache-test" class="log"></div>
    </div>

    <script>
        // –†—É—á–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
        async function registerSW() {
            const registerDiv = document.getElementById('sw-register');
            registerDiv.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Service Worker...';

            try {
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.register('/sw.js', {
                        scope: '/'
                    });
                    
                    registerDiv.textContent = `‚úÖ Service Worker –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω!
Scope: ${registration.scope}
State: ${registration.active?.state || '–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω'}`;
                    registerDiv.parentElement.className = 'test success';
                } else {
                    registerDiv.textContent = '‚ùå Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                    registerDiv.parentElement.className = 'test error';
                }
            } catch (error) {
                registerDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${error.message}`;
                registerDiv.parentElement.className = 'test error';
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
        async function checkStatus() {
            const statusDiv = document.getElementById('sw-status');
            let output = 'üîç –°—Ç–∞—Ç—É—Å Service Worker:\n\n';

            try {
                if ('serviceWorker' in navigator) {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        output += `‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω\n`;
                        output += `Scope: ${registration.scope}\n`;
                        output += `Active: ${registration.active ? '–î–∞' : '–ù–µ—Ç'}\n`;
                        output += `State: ${registration.active?.state || '–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω'}\n`;
                        
                        if (registration.active) {
                            output += `Script URL: ${registration.active.scriptURL}\n`;
                        }
                        
                        statusDiv.parentElement.className = 'test success';
                    } else {
                        output += '‚ùå –ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
                        statusDiv.parentElement.className = 'test error';
                    }
                } else {
                    output += '‚ùå Service Worker –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
                    statusDiv.parentElement.className = 'test error';
                }
            } catch (error) {
                output += `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                statusDiv.parentElement.className = 'test error';
            }

            statusDiv.textContent = output;
        }

        // –¢–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
        async function testCache() {
            const testDiv = document.getElementById('cache-test');
            testDiv.textContent = '–¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ...';

            try {
                // –î–µ–ª–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤
                const requests = [
                    '/api/cities',
                    '/api/clinics'
                ];

                let output = 'üß™ –¢–µ—Å—Ç –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:\n\n';

                for (const url of requests) {
                    try {
                        const startTime = performance.now();
                        const response = await fetch(url);
                        const endTime = performance.now();
                        const duration = Math.round(endTime - startTime);
                        
                        output += `üì° ${url}:\n`;
                        output += `  –°—Ç–∞—Ç—É—Å: ${response.status}\n`;
                        output += `  –í—Ä–µ–º—è: ${duration}ms\n`;
                        
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–µ—à–∞
                        const swCacheDate = response.headers.get('sw-cache-date');
                        if (swCacheDate) {
                            output += `  ‚úÖ SW –∫–µ—à: ${swCacheDate}\n`;
                        } else {
                            output += `  ‚ùå SW –∫–µ—à: –Ω–µ –Ω–∞–π–¥–µ–Ω\n`;
                        }
                        
                    } catch (error) {
                        output += `‚ùå ${url}: ${error.message}\n`;
                    }
                    output += '\n';
                }

                output += 'üí° –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ç–µ—Å—Ç - –≤—Ç–æ—Ä–æ–π —Ä–∞–∑ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –±—ã—Å—Ç—Ä–µ–µ!';
                
                testDiv.textContent = output;
                testDiv.parentElement.className = 'test success';
                
            } catch (error) {
                testDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∞: ${error.message}`;
                testDiv.parentElement.className = 'test error';
            }
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkStatus();
            }, 1000);
        });
    </script>
</body>
</html>
